{% extends "base.html" %}

{% block content %}
<div id="avatar-section">
    <h3>Update Avatar</h3>
    <form id="avatarForm" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <label for="{{ form.avatar.id_for_label }}">Avatar:</label>
        {{ form.avatar }} <!-- Explicitly rendering the avatar field -->
        <button type="submit">Update Avatar</button>
    </form>
</div>

<div class="mt-4">
    <h2>Welcome, {{ user.username }}!</h2>

    <!-- Display General Entries -->
    <div class="mt-4">
        <h3>Your General Entries</h3>
        {% if user_entries %}
            <ul>
                {% for entry in user_entries %}
                    <li>{{ entry.name }} on {{ entry.date|date:"F d, Y" }}</li>
                {% endfor %}
            </ul>
        {% else %}
            <p>You have no general entries.</p>
        {% endif %}
    </div>

    <!-- Display Race Entries -->
    <div class="mt-4">
        <h3>Your Race Entries</h3>
        {% if user_race_entries %}
            <ul>
                {% for race_entry in user_race_entries %}
                    <li>{{ race_entry.race.name }} on {{ race_entry.race.date|date:"F d, Y" }}</li>
                {% endfor %}
            </ul>
        {% else %}
            <p>You have no race entries.</p>
        {% endif %}
    </div>

    <!-- Display Payments -->
    <div class="mt-4">
        <h3>Your Payments</h3>
        {% if user_payments %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in user_payments %}
                    <tr>
                        <td>${{ payment.amount|floatformat:2 }}</td>
                        <td>{{ payment.status }}</td>
                        <td>{{ payment.timestamp|date:"F d, Y H:i" }}</td>
                        <td>{{ payment.content_object }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No payments found.</p>
        {% endif %}
    </div>
</div>

<script>
function submitAvatarForm() {
    const form = document.getElementById('avatarForm');
    const formData = new FormData(form);
    fetch('{{ request.path }}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Accept': 'text/html',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(html => {
        document.getElementById('avatar-section').innerHTML = html;
    })
    .catch(error => console.error('Error updating avatar:', error));
}
</script>
{% endblock %}
